<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>EL BAYT ‚Äî Planner (Supabase)</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --ink:#243133; --muted:#5d6f70; --paper:#fffdfb; --card:#ffffff;
    --radius:18px; --shadow: 0 18px 40px rgba(0,0,0,.06), 0 6px 18px rgba(0,0,0,.05);
    --s1:#FDE3E9; --s2:#F9A6BE; --s3:#E35E83;
    --i1:#EAF5FF; --i2:#A8D4FF; --i3:#4C9EEB;
    --r1:#FFF0E6; --r2:#FFBE95; --r3:#F57C42;
    --a1:#F1F6E9; --a2:#CDE3A1; --a3:#7BA640;
    --b1:#F4EEFF; --b2:#C6B6F3; --b3:#7B66E9;
    --n1:#FFF8E5; --n2:#FFE18A; --n3:#FFB400;
    --k1:#EFFFF1; --k2:#B8F5C2; --k3:#4CCB6E;
    --w1:#E8F9FB; --w2:#9CE7F0; --w3:#2AB3C9;
    --d1:#F7EEFF; --d2:#D9B8FF; --d3:#9A5EF7;
    --c1:#FFF1F1; --c2:#FFBABA; --c3:#FF6B6B;
    --acc1: var(--s1); --acc2: var(--s2); --acc3: var(--s3);
  }
  *{box-sizing:border-box}
  body{margin:0; color:var(--ink); background: radial-gradient(1200px 800px at 80% -100px, #fff4f1 0%, #ffffff 60%), linear-gradient(180deg,#ffffff,#fffaf6 120vh);
       font-family:Poppins, system-ui, -apple-system, Segoe UI, Roboto, Arial;}
  .app{max-width:1280px; margin:24px auto; padding:0 16px 80px;}
  header{display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap}
  .brand{display:flex; gap:14px; align-items:center}
  .logo{width:50px; height:50px; border-radius:14px; background: radial-gradient(100% 100% at 30% 20%, var(--acc2), var(--acc3)); box-shadow: var(--shadow); position:relative; overflow:hidden;}
  h1{margin:0; font-size:28px; letter-spacing:.3px}
  .subtitle{margin-top:2px; font-size:13px; color:var(--muted)}
  .toolbar{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
  select,button,input[type="email"],input[type="password"]{appearance:none; border:1px solid #e9e9e9; border-radius:14px; padding:10px 14px; font-weight:600; box-shadow: var(--shadow);}
  select{background:#fff; color:var(--ink);}
  button.primary{background:var(--acc3); color:#fff; border-color:transparent; cursor:pointer}
  button.ghost{background:#fff; color:var(--muted); border-color:#eee; cursor:pointer}
  nav.months{display:grid; grid-template-columns:repeat(6,1fr); gap:10px; margin:14px 0 10px;}
  .month{border:1px solid #eee; background: linear-gradient(180deg,#fff, var(--acc1)); border-radius:14px; padding:10px; text-align:center; font-weight:700; color:#364243; cursor:pointer; position:relative; overflow:hidden;}
  .month .spark{position:absolute; right:-10px; top:-10px; width:56px; height:56px; background: radial-gradient(closest-side,var(--acc2), transparent); filter: blur(8px); opacity:.6}
  .month.active{outline: 0 0 0 3px rgba(0,0,0,.06); border-color: transparent; color:#0f1b1c; transform: translateY(-1px);}
  .banner{margin-top:8px; position:relative; border-radius:22px; padding:22px; overflow:hidden; background: linear-gradient(120deg, var(--acc2), var(--acc1)); border:1px solid #eee;}
  .banner h2{margin:0; font-size:22px}
  .banner .quote{color:#1d2a2b; opacity:.85; font-size:14px; margin-top:6px}
  .grid{display:grid; grid-template-columns: 1.15fr 1.85fr; gap:16px; margin-top:16px}
  @media (max-width: 980px){ .grid{grid-template-columns:1fr} }
  .card{background:var(--card); border:1px solid #f1f1f1; border-radius:18px; padding:16px; box-shadow: var(--shadow);}
  .card h3{margin:0 0 10px; font-size:18px; display:flex; align-items:center; gap:8px}
  .field label{display:block; font-size:13px; color:var(--muted); margin-bottom:6px}
  .field input[type="text"], .field textarea, .field select{width:100%; border:1px solid #efefef; border-radius:14px; padding:11px 12px; background:#fff; font: inherit; color:var(--ink); box-shadow: inset 0 -20px 80px rgba(0,0,0,.02);}
  .field textarea{min-height:110px; resize:vertical}
  .hint{font-size:12.5px; color:var(--muted); margin-top:6px}
  .prayer{overflow:auto; border-radius:14px; border:1px solid #efefef; background: linear-gradient(180deg,#fff, var(--acc1));}
  table{border-collapse:separate; border-spacing:0; width:100%; background:transparent}
  th, td{padding:10px 10px; border-bottom:1px solid #f2f2f2; text-align:center; white-space:nowrap}
  th{position:sticky; top:0; background:linear-gradient(180deg,#fff,var(--acc1)); z-index:1}
  tr:last-child td{border-bottom:none}
  .daycol{text-align:left; font-weight:700; color:#3a484a}
  .wksep td{background:#fff9; font-weight:700}
  .points{font-weight:700}
  .progress{height:10px; background:#f1f1f1; border-radius:999px; overflow:hidden}
  .bar{height:100%; background:var(--acc3); width:0%}
  .pill{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:var(--acc1); border:1px solid #efefef; margin:4px 6px 0 0; color:#405051; font-weight:600; font-size:13px}
  /* Quran planner */
  .q-grid{display:grid; grid-template-columns:1fr; gap:12px}
  .q-plan{border:1px solid #efefef; border-radius:16px; padding:12px; background: linear-gradient(180deg,#fff, var(--acc1));}
  .q-title{display:flex; align-items:center; justify-content:space-between; gap:12px}
  .q-title strong{font-size:16px}
  .q-verses{display:flex; flex-wrap:wrap; gap:6px; margin-top:10px}
  .v-chip{display:inline-flex; align-items:center; gap:6px; padding:6px 8px; border-radius:999px; border:1px solid #eaeaea; background:#fff; font-size:12.5px}
  .v-chip input{accent-color: var(--acc3)}
  .q-progress{display:flex; align-items:center; gap:10px; margin-top:8px}
  .q-pct{font-weight:700}
  /* Auth */
  .auth{display:flex; gap:8px; align-items:center}
  .auth input{min-width:200px}
  .sep{height:1px; background:#eee; margin:12px 0}
  /* Toast & confetti */
  .toast{position:fixed; right:16px; bottom:16px; background:#ffffff; border:1px solid #e8e8e8; box-shadow: var(--shadow); padding:12px 14px; border-radius:14px; font-weight:700; color:#2f3b3c; display:none}
  .confetti{position:fixed; pointer-events:none; left:0; top:0; width:100%; height:100%; overflow:hidden}
  .c{position:absolute; font-size:20px; animation: confetti 1200ms ease-out forwards}
  @keyframes confetti{
    0%{ transform: translate(var(--x), calc(var(--y) - 20px)) scale(.8); opacity:0 }
    10%{ opacity:1 }
    100%{ transform: translate(var(--x2), var(--y2)) rotate(25deg); opacity:0 }
  }
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>EL BAYT ‚Äî Planner</h1>
        <div class="subtitle">Supabase ‚Ä¢ Comptes & synchronisation ‚Ä¢ Pri√®re ‚Ä¢ Coran ‚Ä¢ R√©compenses</div>
      </div>
    </div>
    <div class="toolbar">
      <div class="auth" id="authBox">
        <input type="email" id="email" placeholder="email"/>
        <input type="password" id="password" placeholder="mot de passe"/>
        <button class="ghost" id="btnSignup">Cr√©er</button>
        <button class="primary" id="btnSignin">Se connecter</button>
      </div>
      <div class="auth" id="userBox" style="display:none">
        <span id="userEmail" class="pill"></span>
        <button class="ghost" id="btnSignout">Se d√©connecter</button>
      </div>
      <select id="yearSelect" title="Ann√©e"></select>
      <button id="printBtn" class="primary">Imprimer</button>
    </div>
  </header>

  <nav class="months" id="monthNav" aria-label="Mois"></nav>

  <section class="banner">
    <h2 id="bannerTitle">LE MOIS DE SABR ¬∑ La patience</h2>
    <div class="quote" id="bannerQuote">‚ÄúUn pas apr√®s l‚Äôautre, avec douceur et sinc√©rit√©.‚Äù</div>
  </section>

  <div id="appContent" style="display:none">
    <div class="grid">
      <!-- Left column -->
      <section class="card">
        <h3>üåø M√©ta du mois</h3>
        <div class="field">
          <label for="themeMois">Th√®me du mois</label>
          <select id="themeMois">
            <option value="sabr">Sabr (Patience)</option>
            <option value="ikhlas">Ikhl√¢s (Sinc√©rit√©)</option>
            <option value="rahma">Rahma (Mis√©ricorde)</option>
            <option value="amal">‚ÄòAmal (Espoir)</option>
            <option value="baraka">Baraka (B√©n√©diction)</option>
            <option value="nour">An Nour (Lumi√®re)</option>
            <option value="karim">Al-Kar√Æm (G√©n√©rosit√©)</option>
            <option value="wahhab">Al-Wahh√¢b (Don gratuit)</option>
            <option value="dhikr">Dhikr (Rappel)</option>
            <option value="choukr">Choukr (Gratitude)</option>
          </select>
        </div>
        <div class="field" style="margin-top:12px">
          <label>Intentions du mois</label>
          <textarea id="intentions"></textarea>
        </div>
        <div class="field" style="margin-top:12px">
          <label>Objectifs Akhira</label>
          <textarea id="objAkhira"></textarea>
        </div>
        <div class="field" style="margin-top:12px">
          <label>Objectifs Dounia</label>
          <textarea id="objDounia"></textarea>
        </div>

        <div class="field" style="margin-top:12px">
          <label>R√©compenses (d√©bloqu√©es par points)</label>
          <div id="rewardsList"></div>
          <div class="sep"></div>
          <div style="display:flex; gap:8px; align-items:center">
            <input id="newRewardText" type="text" placeholder="Ex: Sortie famille, livre‚Ä¶">
            <select id="newRewardPoints">
              <option value="50">50 pts</option>
              <option value="100">100 pts</option>
              <option value="200">200 pts</option>
            </select>
            <button class="ghost" id="addRewardBtn">Ajouter</button>
          </div>
        </div>
        <div class="field" style="margin-top:12px">
          <label>Progression mensuelle</label>
          <div class="progress"><div class="bar" id="progressBar"></div></div>
          <div class="hint"><span id="pointsTotal">0</span> points ‚Äî <span id="daysPerfect">0</span> jour(s) parfait(s)</div>
        </div>
        <div class="field" style="margin-top:12px">
          <label><input type="checkbox" id="quranPointsToggle"> +1 point par verset m√©moris√© (optionnel)</label>
        </div>
      </section>

      <!-- Right column -->
      <section class="card">
        <h3>üïå Suivi Pri√®re (quotidien)</h3>
        <div class="prayer">
          <table id="prayerTable">
            <thead>
              <tr>
                <th>Jour</th>
                <th>Fajr</th>
                <th>Dhuhr</th>
                <th>‚ÄòAsr</th>
                <th>Maghrib</th>
                <th>‚ÄòIsha</th>
                <th style="min-width:180px">Objectif du jour</th>
                <th>Atteint</th>
                <th>Points (jour)</th>
              </tr>
            </thead>
            <tbody id="prayerBody"></tbody>
          </table>
        </div>
      </section>

      <!-- Quran Planner -->
      <section class="card">
        <h3>üìñ Planification du Coran</h3>
        <div class="hint">Cr√©e un plan (Sourate + plage de versets), puis coche chaque verset m√©moris√© üéâ</div>
        <div class="field" style="display:grid; grid-template-columns:1fr 1fr 1fr auto; gap:8px; align-items:end; margin-top:8px">
          <div>
            <label>Sourate</label>
            <input id="qpSurah" type="text" placeholder="Ex: Al-Baqara"/>
          </div>
          <div>
            <label>De (verset)</label>
            <input id="qpFrom" type="number" min="1" placeholder="1"/>
          </div>
          <div>
            <label>√Ä (verset)</label>
            <input id="qpTo" type="number" min="1" placeholder="7"/>
          </div>
          <div><button class="ghost" id="qpAddBtn">Ajouter</button></div>
        </div>

        <div class="q-grid" id="qPlans" style="margin-top:12px"></div>
        <div class="field" style="margin-top:12px">
          <label>Progression Coran (tous plans)</label>
          <div class="progress"><div class="bar" id="quranProgressBar"></div></div>
          <div class="hint"><span id="quranLearned">0</span>/<span id="quranTotal">0</span> versets m√©moris√©s</div>
        </div>
      </section>
    </div>
  </div>
</div>

<div class="toast" id="toast">MashaAllah !</div>
<div class="confetti" id="confetti"></div>

<!-- Supabase SDK -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
/* ========= CONFIGURER ICI =========
   1) Copie COLLE ton Project URL et ta anon key Supabase ci-dessous
   2) D√©ploie ce fichier sur Netlify/Vercel/GitHub Pages
*/
const SUPABASE_URL = "https://dyxjnhdiarxsydbugdqi.supabase.co";    // <-- √† remplacer
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR5eGpuaGRpYXJ4c3lkYnVnZHFpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4MTQ5MjEsImV4cCI6MjA3MDM5MDkyMX0.nLMhKec3xkO7t6tEE6JiAKTm64rPyGqg1YyQUGM5Py4";                      // <-- √† remplacer
/* ================================== */

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

/* ===== Theme palettes ===== */
const THEME = {
  sabr:["--s1","--s2","--s3"], ikhlas:["--i1","--i2","--i3"], rahma:["--r1","--r2","--r3"],
  amal:["--a1","--a2","--a3"], baraka:["--b1","--b2","--b3"], nour:["--n1","--n2","--n3"],
  karim:["--k1","--k2","--k3"], wahhab:["--w1","--w2","--w3"], dhikr:["--d1","--d2","--d3"],
  choukr:["--c1","--c2","--c3"]
};
const BANNER = {
  sabr:"LE MOIS DE SABR ¬∑ La patience",
  ikhlas:"LE MOIS D‚ÄôIKHL√ÇS ¬∑ La sinc√©rit√©",
  rahma:"LE MOIS DE RAHMA ¬∑ La mis√©ricorde",
  amal:"LE MOIS D‚ÄôAMAL ¬∑ L‚Äôespoir",
  baraka:"LE MOIS DE BARAKA ¬∑ La b√©n√©diction",
  nour:"LE MOIS D‚ÄôAN-NOUR ¬∑ La lumi√®re",
  karim:"LE MOIS D‚ÄôAL-KAR√éM ¬∑ La g√©n√©rosit√©",
  wahhab:"LE MOIS D‚ÄôAL-WAHH√ÇB ¬∑ Le don",
  dhikr:"LE MOIS DU DHIKR ¬∑ Le rappel",
  choukr:"LE MOIS DE CHOUKR ¬∑ La gratitude"
};
const QUOTE = {
  sabr:"‚ÄúSois constante, un pas apr√®s l‚Äôautre.‚Äù",
  ikhlas:"‚ÄúLes actions ne valent que par les intentions.‚Äù",
  rahma:"‚ÄúLa douceur gu√©rit ce que la duret√© blesse.‚Äù",
  amal:"‚ÄúQuiconque craint Allah, Il lui donnera une issue.‚Äù",
  baraka:"‚ÄúVois l‚Äôabondance dans la simplicit√©.‚Äù",
  nour:"‚ÄúAllah est la Lumi√®re des cieux et de la terre.‚Äù",
  karim:"‚ÄúDonner au-del√† des attentes.‚Äù",
  wahhab:"‚ÄúTout don vient de Lui.‚Äù",
  dhikr:"‚ÄúPar le rappel d‚ÄôAllah, les c≈ìurs se tranquillisent.‚Äù",
  choukr:"‚ÄúRemercie pour le visible et l‚Äôinvisible.‚Äù"
};

/* ===== Utils ===== */
const MONTHS = ["Jan","F√©v","Mar","Avr","Mai","Juin","Juil","Ao√ªt","Sep","Oct","Nov","D√©c"];
const $ = s => document.querySelector(s);
function yearNow(){ return new Date().getFullYear(); }
function monthNow(){ return new Date().getMonth(); }
function daysInMonth(y,m){ return new Date(y, m+1, 0).getDate(); }

/* ===== State ===== */
let state = {
  year: yearNow(),
  month: monthNow(),
  monthRow: null,   // months table row
  prayers: {},      // day -> row
  rewards: [],
  quranPlans: [],
  quranPoints: false,
  theme: "sabr",
  fields: { intentions:"", objAkhira:"", objDounia:"", gratitudes:"", wins:"", notes:"" }
};

/* ===== Auth UI ===== */
async function refreshAuthUI(){
  const { data: { user } } = await supabase.auth.getUser();
  $("#authBox").style.display = user ? "none" : "flex";
  $("#userBox").style.display = user ? "flex" : "none";
  $("#appContent").style.display = user ? "block" : "none";
  if(user){ $("#userEmail").textContent = user.email || user.phone || "connect√©"; await loadAll(); }
}

/* ===== Supabase data access ===== */
async function getOrCreateMonth(year, month){
  const { data: { user } } = await supabase.auth.getUser();
  if(!user) throw new Error("Non authentifi√©");
  let { data: rows, error } = await supabase
    .from("months").select("*")
    .eq("user_id", user.id).eq("year", year).eq("month", month).limit(1);
  if(error) throw error;
  if(rows && rows.length) return rows[0];
  const insert = { user_id: user.id, year, month };
  const { data, error:err2 } = await supabase.from("months").insert(insert).select("*").single();
  if(err2) throw err2;
  return data;
}

async function loadPrayers(month_id){
  const map = {};
  const { data, error } = await supabase.from("prayers").select("*").eq("month_id", month_id);
  if(error) throw error;
  data.forEach(r=> map[r.day] = r);
  return map;
}
async function upsertPrayer(month_id, day, patch){
  const existing = state.prayers[day];
  if(existing){
    const { error } = await supabase.from("prayers").update(patch).eq("id", existing.id);
    if(error) console.error(error);
    Object.assign(existing, patch);
    return existing;
  }else{
    const row = { month_id, day, ...patch };
    const { data, error } = await supabase.from("prayers").insert(row).select("*").single();
    if(error) console.error(error);
    state.prayers[day] = data;
    return data;
  }
}

async function loadRewards(month_id){
  const { data, error } = await supabase.from("rewards").select("*").eq("month_id", month_id).order("points", { ascending: true });
  if(error) throw error;
  return data || [];
}
async function addReward(month_id, label, points){
  const { data, error } = await supabase.from("rewards").insert({ month_id, label, points, claimed:false }).select("*").single();
  if(error) throw error;
  state.rewards.push(data);
  return data;
}
async function claimReward(id){
  const { error } = await supabase.from("rewards").update({ claimed:true }).eq("id", id);
  if(error) throw error;
  const r = state.rewards.find(x=>x.id===id); if(r) r.claimed=true;
}

async function loadQuran(month_id){
  const { data: plans, error } = await supabase.from("quran_plans").select("*").eq("month_id", month_id);
  if(error) throw error;
  const ids = plans.map(p=>p.id);
  let versesByPlan = {};
  if(ids.length){
    const { data: verses, error:err2 } = await supabase.from("quran_plan_verses").select("*").in("plan_id", ids);
    if(err2) throw err2;
    verses.forEach(v=>{
      if(!versesByPlan[v.plan_id]) versesByPlan[v.plan_id] = {};
      versesByPlan[v.plan_id][v.verse] = !!v.learned;
    });
  }
  return plans.map(p=> ({ ...p, learned: versesByPlan[p.id] || {} }));
}
async function addQuranPlan(month_id, surah, v_from, v_to){
  const { data: plan, error } = await supabase.from("quran_plans").insert({ month_id, surah, v_from, v_to }).select("*").single();
  if(error) throw error;
  const verses = [];
  for(let v=v_from; v<=v_to; v++){ verses.push({ plan_id: plan.id, verse: v, learned: false }); }
  const { error: err2 } = await supabase.from("quran_plan_verses").insert(verses);
  if(err2) throw err2;
  state.quranPlans.push({ ...plan, learned: Object.fromEntries(verses.map(v=>[v.verse,false])) });
  return plan;
}
async function toggleVerse(plan_id, verse, learned){
  const { error } = await supabase.from("quran_plan_verses").update({ learned }).eq("plan_id", plan_id).eq("verse", verse);
  if(error) throw error;
}

/* ===== Points rules (prayers) ===== */
function computeDayPoints(row){
  let p = 0;
  p += row.fajr?1:0;
  p += row.dhuhr?1:0;
  p += row.asr?1:0;
  p += row.maghrib?1:0;
  p += row.isha?1:0;
  if(row.achieved) p += 3;
  const perfect = row.fajr && row.dhuhr && row.asr && row.maghrib && row.isha;
  if(perfect) p += 2;
  return p;
}

/* ===== UI helpers ===== */
function applyTheme(){
  const t = state.theme || "sabr";
  const vars = THEME[t] || THEME.sabr;
  const root = document.documentElement;
  root.style.setProperty("--acc1", getComputedStyle(root).getPropertyValue(vars[0]));
  root.style.setProperty("--acc2", getComputedStyle(root).getPropertyValue(vars[1]));
  root.style.setProperty("--acc3", getComputedStyle(root).getPropertyValue(vars[2]));
  $("#bannerTitle").textContent = BANNER[t];
  $("#bannerQuote").textContent = QUOTE[t];
}
function showToast(msg){
  const t = $("#toast");
  t.textContent = msg;
  t.style.display = "block";
  setTimeout(()=> t.style.display="none", 1600);
}
function confettiBurst(x, y){
  const wrap = $("#confetti");
  for(let i=0;i<14;i++){
    const e = document.createElement("div"); e.className="c";
    e.textContent = ["üéâ","‚ú®","üåü","üí´","üü°","üü£","üü¢"][Math.floor(Math.random()*7)];
    const dx = (Math.random()*160 - 80), dy = (Math.random()*120 + 60);
    e.style.setProperty("--x", x+"px"); e.style.setProperty("--y", y+"px");
    e.style.setProperty("--x2", (x+dx)+"px"); e.style.setProperty("--y2", (y+dy)+"px");
    wrap.appendChild(e);
    setTimeout(()=> wrap.removeChild(e), 1300);
  }
}

/* ===== Rendering ===== */
function buildYearSelect(){
  const y = $("#yearSelect"); const base = yearNow();
  y.innerHTML = "";
  for(let dy=-2; dy<=3; dy++){
    const val = base + dy;
    const opt = document.createElement("option");
    opt.value = val; opt.textContent = val; if(val===state.year) opt.selected=true;
    y.appendChild(opt);
  }
  y.onchange = ()=>{ state.year = parseInt(y.value,10); loadAll(); };
}
function buildMonthNav(){
  const nav = $("#monthNav"); nav.innerHTML = "";
  for(let i=0;i<12;i++){
    const btn = document.createElement("button");
    btn.className = "month" + (i===state.month ? " active" : "");
    btn.innerHTML = MONTHS[i] + '<span class="spark"></span>';
    btn.addEventListener("click", ()=>{
      state.month = i; window.location.hash = `#/${state.year}/${String(i+1).padStart(2,'0')}`;
      loadAll();
    });
    nav.appendChild(btn);
  }
}

function renderRewards(){
  const wrap = $("#rewardsList");
  wrap.innerHTML = "";
  state.rewards.forEach(r=>{
    const row = document.createElement("div");
    row.className = "q-plan";
    row.innerHTML = `<div class="q-title">
      <div><strong>${r.label}</strong> <span class="opt">${r.points} pts</span></div>
      <div>${r.claimed? '<span class="pill">R√©clam√© ‚úÖ</span>' : `<button class="ghost" data-claim="${r.id}">${ monthPoints()>=r.points ? 'R√©clamer' : 'Bloqu√©' }</button>`}</div>
    </div>`;
    wrap.appendChild(row);
  });
  wrap.querySelectorAll("button[data-claim]").forEach(btn=>{
    const id = parseInt(btn.getAttribute("data-claim"),10);
    const r = state.rewards.find(x=>x.id===id);
    btn.disabled = !(monthPoints() >= r.points);
    btn.addEventListener("click", async ()=>{ await claimReward(id); renderRewards(); });
  });
}

function renderPrayerTable(){
  const body = $("#prayerBody"); body.innerHTML="";
  const days = daysInMonth(state.year, state.month);
  for(let d=1; d<=days; d++){
    const row = state.prayers[d] || { day:d, fajr:false, dhuhr:false, asr:false, maghrib:false, isha:false, objective:"", achieved:false, points:0 };
    const tr = document.createElement("tr");
    const tdDay = document.createElement("td"); tdDay.className="daycol"; tdDay.textContent = String(d).padStart(2,"0"); tr.appendChild(tdDay);

    const mkCheck = (key)=>{
      const td = document.createElement("td");
      const cb = document.createElement("input"); cb.type="checkbox"; cb.checked = !!row[key];
      cb.addEventListener("change", async ()=>{
        row[key] = cb.checked; row.points = computeDayPoints(row);
        await upsertPrayer(state.monthRow.id, d, row);
        state.prayers[d] = row;
        updateTotals(); tdPts.textContent = row.points;
      });
      td.appendChild(cb); tr.appendChild(td);
    };
    mkCheck("fajr"); mkCheck("dhuhr"); mkCheck("asr"); mkCheck("maghrib"); mkCheck("isha");

    const tdObj = document.createElement("td");
    const input = document.createElement("input");
    input.type="text"; input.placeholder="Ex: √Ä l‚Äôheure / Sunna Fajr / Mosqu√©e ‚Ä¶"; input.value = row.objective || "";
    input.addEventListener("input", async ()=>{
      row.objective = input.value; await upsertPrayer(state.monthRow.id, d, row); state.prayers[d] = row;
    });
    tdObj.appendChild(input); tr.appendChild(tdObj);

    const tdAch = document.createElement("td");
    const cbA = document.createElement("input"); cbA.type="checkbox"; cbA.checked = !!row.achieved;
    cbA.addEventListener("change", async ()=>{
      row.achieved = cbA.checked; row.points = computeDayPoints(row);
      await upsertPrayer(state.monthRow.id, d, row); state.prayers[d] = row;
      updateTotals(); tdPts.textContent = row.points;
    });
    tdAch.appendChild(cbA); tr.appendChild(tdAch);

    const tdPts = document.createElement("td"); tdPts.className="points"; tdPts.textContent = row.points || 0; tr.appendChild(tdPts);

    if(d%7===0){ tr.classList.add("wksep"); }
    body.appendChild(tr);
  }
}

function quranTotalVerses(){
  return state.quranPlans.reduce((sum,p)=> sum + (p.v_to - p.v_from + 1), 0);
}
function quranLearnedTotal(){
  let s=0;
  state.quranPlans.forEach(p=>{
    for(let v=p.v_from; v<=p.v_to; v++){ if(p.learned && p.learned[v]) s++; }
  });
  return s;
}
function quranOverallProgress(){
  const total = quranTotalVerses();
  const learned = quranLearnedTotal();
  const pct = Math.min(100, Math.round(100*learned/Math.max(1,total)));
  $("#quranTotal").textContent = total;
  $("#quranLearned").textContent = learned;
  $("#quranProgressBar").style.width = pct + "%";
}
async function onVerseToggle(plan, verse, checkbox){
  plan.learned[verse] = checkbox.checked;
  await toggleVerse(plan.id, verse, checkbox.checked);
  if(checkbox.checked){
    const rect = checkbox.getBoundingClientRect();
    showToast(`MashaAllah ! Verset ${verse} de ${plan.surah} m√©moris√© üå∏`);
    confettiBurst(rect.left + rect.width/2, rect.top + rect.height/2);
    if(state.quranPoints){ updateTotals(); }
  } else { updateTotals(); }
  quranOverallProgress();
}
function renderQuranPlans(){
  const root = $("#qPlans"); root.innerHTML="";
  state.quranPlans.forEach((p)=>{
    const wrap = document.createElement("div"); wrap.className="q-plan";
    const title = document.createElement("div"); title.className="q-title";
    const left = document.createElement("div");
    left.innerHTML = `<strong>${p.surah}</strong> <span class="opt">versets ${p.v_from}‚Äì${p.v_to}</span>`;
    const right = document.createElement("div");
    const del = document.createElement("button"); del.className="ghost"; del.textContent="Supprimer";
    del.addEventListener("click", async ()=>{
      await supabase.from("quran_plans").delete().eq("id", p.id);
      state.quranPlans = state.quranPlans.filter(x=>x.id!==p.id);
      renderQuranPlans(); updateTotals(); quranOverallProgress();
    });
    right.appendChild(del);
    title.appendChild(left); title.appendChild(right); wrap.appendChild(title);

    const verses = document.createElement("div"); verses.className="q-verses";
    for(let v=p.v_from; v<=p.v_to; v++){
      const chip = document.createElement("label"); chip.className="v-chip";
      const cb = document.createElement("input"); cb.type="checkbox"; cb.checked = !!(p.learned && p.learned[v]);
      cb.addEventListener("change", ()=> onVerseToggle(p, v, cb));
      const txt = document.createElement("span"); txt.textContent = v;
      chip.appendChild(cb); chip.appendChild(txt);
      verses.appendChild(chip);
    }
    wrap.appendChild(verses);

    const planProg = document.createElement("div"); planProg.className="q-progress";
    const progBar = document.createElement("div"); progBar.className="progress"; progBar.style.flex=1;
    const inner = document.createElement("div"); inner.className="bar";
    const learned = Object.values(p.learned||{}).filter(Boolean).length;
    const total = (p.v_to - p.v_from + 1);
    inner.style.width = Math.round(100*learned/Math.max(1,total)) + "%";
    progBar.appendChild(inner);
    const pct = document.createElement("div"); pct.className="q-pct"; text = `${learned}/${total}`; pct.textContent = text;
    planProg.appendChild(progBar); planProg.appendChild(pct);
    wrap.appendChild(planProg);

    root.appendChild(wrap);
  });
  quranOverallProgress();
}

function monthPoints(){
  const prayerPts = Object.values(state.prayers).reduce((sum, r)=> sum + (r.points || 0), 0);
  const quranPts  = state.quranPoints ? quranLearnedTotal() : 0;
  return prayerPts + quranPts;
}
function perfectDays(){
  let n=0; Object.values(state.prayers).forEach(r=>{ if(r.fajr&&r.dhuhr&&r.asr&&r.maghrib&&r.isha) n++; });
  return n;
}
function updateTotals(){
  $("#pointsTotal").textContent = monthPoints();
  $("#daysPerfect").textContent = perfectDays();
  const maxPrayers = daysInMonth(state.year, state.month) * (5 + 3 + 2);
  const maxQuran   = state.quranPoints ? quranTotalVerses() : 0;
  const maxPossible = maxPrayers + maxQuran;
  const pct = Math.min(100, Math.round(100*monthPoints()/Math.max(1,maxPossible)));
  $("#progressBar").style.width = pct + "%";
  renderRewards();
}

/* ===== Load all data for current month ===== */
async function loadAll(){
  try{
    $("#appContent").style.display = "none";
    const m = location.hash.match(/^#\/(\d{4})\/(\d{2})$/);
    if(m){ state.year = parseInt(m[1],10); state.month = Math.min(11, Math.max(0, parseInt(m[2],10)-1)); }
    buildYearSelect(); buildMonthNav();
    state.monthRow = await getOrCreateMonth(state.year, state.month);
    state.prayers = await loadPrayers(state.monthRow.id);
    renderPrayerTable();
    state.rewards = await loadRewards(state.monthRow.id);
    renderRewards();
    state.quranPlans = await loadQuran(state.monthRow.id);
    renderQuranPlans();
    $("#themeMois").value = state.theme;
    $("#themeMois").onchange = ()=>{ state.theme = $("#themeMois").value; applyTheme(); };
    $("#quranPointsToggle").checked = !!state.quranPoints;
    $("#quranPointsToggle").onchange = ()=>{ state.quranPoints = $("#quranPointsToggle").checked; updateTotals(); };
    applyTheme(); updateTotals();
    $("#appContent").style.display = "block";
  }catch(e){
    console.error(e);
    alert("Erreur de chargement : " + e.message);
  }
}

/* ===== Events ===== */
$("#btnSignup").addEventListener("click", async ()=>{
  const email = $("#email").value.trim(); const password = $("#password").value;
  const { error } = await supabase.auth.signUp({ email, password });
  if(error) return alert(error.message);
  alert("Compte cr√©√©. V√©rifie ton email (si confirmation activ√©e).");
  await refreshAuthUI();
});
$("#btnSignin").addEventListener("click", async ()=>{
  const email = $("#email").value.trim(); const password = $("#password").value;
  const { error } = await supabase.auth.signInWithPassword({ email, password });
  if(error) return alert(error.message);
  await refreshAuthUI();
});
$("#btnSignout").addEventListener("click", async ()=>{
  await supabase.auth.signOut();
  await refreshAuthUI();
});
$("#printBtn").addEventListener("click", ()=> window.print());

$("#addRewardBtn").addEventListener("click", async ()=>{
  const text = $("#newRewardText").value.trim();
  const pts = parseInt($("#newRewardPoints").value,10);
  if(!text) return;
  await addReward(state.monthRow.id, text, pts);
  $("#newRewardText").value="";
  renderRewards();
});

$("#qpAddBtn").addEventListener("click", async ()=>{
  const s = $("#qpSurah").value.trim();
  const f = parseInt($("#qpFrom").value,10);
  const t = parseInt($("#qpTo").value,10);
  if(!s || !f || !t || t<f) return alert("Renseigne la sourate et une plage valide.");
  await addQuranPlan(state.monthRow.id, s, f, t);
  $("#qpSurah").value=""; $("#qpFrom").value=""; $("#qpTo").value="";
  renderQuranPlans(); updateTotals();
});

window.addEventListener("hashchange", loadAll);

/* ===== Init ===== */
(async function init(){
  applyTheme();
  await refreshAuthUI();
})();
</script>

<!--
=====================
SQL Supabase √† ex√©cuter
=====================

-- months
create table if not exists months (
  id uuid primary key default gen_random_uuid(),
  user_id uuid not null references auth.users(id) on delete cascade,
  year int not null,
  month int not null,
  unique (user_id, year, month)
);
alter table months enable row level security;
create policy "own months"
on months for all
using (auth.uid() = user_id)
with check (auth.uid() = user_id);

-- prayers
create table if not exists prayers (
  id bigserial primary key,
  month_id uuid not null references months(id) on delete cascade,
  day int not null,
  fajr bool default false,
  dhuhr bool default false,
  asr bool default false,
  maghrib bool default false,
  isha bool default false,
  objective text,
  achieved bool default false,
  points int default 0,
  unique (month_id, day)
);
alter table prayers enable row level security;
create policy "own prayers"
on prayers for all
using (exists (select 1 from months m where m.id = month_id and m.user_id = auth.uid()))
with check (exists (select 1 from months m where m.id = month_id and m.user_id = auth.uid()));

-- rewards
create table if not exists rewards (
  id bigserial primary key,
  month_id uuid not null references months(id) on delete cascade,
  label text not null,
  points int not null,
  claimed bool default false
);
alter table rewards enable row level security;
create policy "own rewards"
on rewards for all
using (exists (select 1 from months m where m.id = month_id and m.user_id = auth.uid()))
with check (exists (select 1 from months m where m.id = month_id and m.user_id = auth.uid()));

-- quran_plans
create table if not exists quran_plans (
  id uuid primary key default gen_random_uuid(),
  month_id uuid not null references months(id) on delete cascade,
  surah text not null,
  v_from int not null,
  v_to int not null
);
alter table quran_plans enable row level security;
create policy "own quran_plans"
on quran_plans for all
using (exists (select 1 from months m where m.id = month_id and m.user_id = auth.uid()))
with check (exists (select 1 from months m where m.id = month_id and m.user_id = auth.uid()));

-- quran_plan_verses
create table if not exists quran_plan_verses (
  id bigserial primary key,
  plan_id uuid not null references quran_plans(id) on delete cascade,
  verse int not null,
  learned bool default false,
  unique (plan_id, verse)
);
alter table quran_plan_verses enable row level security;
create policy "own quran_plan_verses"
on quran_plan_verses for all
using (exists (select 1 from quran_plans p join months m on m.id=p.month_id where p.id=plan_id and m.user_id=auth.uid()))
with check (exists (select 1 from quran_plans p join months m on m.id=p.month_id where p.id=plan_id and m.user_id=auth.uid()));
-->
</html>
